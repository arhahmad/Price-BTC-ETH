<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Crypto Price</title>
  <meta name="theme-color" content="#1a1a1a">
  <link rel="icon" href="https://bitcoin.org/img/icons/opengraph.png">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <link rel="manifest" href="/manifest.json">
  <style>
    :root {
      --primary-color: #4a90e2;
      --background-color: #1a1a1a;
      --text-color: #ffffff;
      --menu-button-color: #ffffff;
      --battery-icon-color: #333333;
      --change-positive: #00cc00;
      --change-negative: #ff3333;
      --date-header-color: #333333;
    }

    .night-mode {
      --background-color: #0a0a0a;
      --primary-color: #3a7bd5;
      --text-color: #e0e0e0;
      --date-header-color: #222222;
      filter: brightness(0.8);
    }

    .grayscale-mode {
      filter: grayscale(100%);
    }

    body {
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background-color: var(--background-color);
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
      text-align: center;
      color: var(--text-color);
      position: relative;
      overflow: hidden;
      transition: background-color 0.3s ease;
    }

    .date-header {
      position: absolute;
      top: 20px;
      left: 20px;
      background-color: var(--date-header-color);
      color: white;
      padding: 10px 18px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      cursor: pointer;
      letter-spacing: 1px;
    }

    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      max-width: 100%;
      box-sizing: border-box;
    }

    h1 {
      font-size: 32px;
      color: var(--primary-color);
      margin-bottom: 20px;
      opacity: 0.9;
      font-weight: 400;
    }

    .price {
      font-size: 100px;
      font-weight: 500;
      color: var(--text-color);
      margin-bottom: 10px;
      will-change: transform, opacity;
      text-rendering: optimizeSpeed;
    }

    .price-update {
      animation: priceChange 0.5s ease;
    }

    @keyframes priceChange {
      0% { opacity: 0.5; transform: scale(0.95); }
      50% { opacity: 1; transform: scale(1.05); }
      100% { opacity: 1; transform: scale(1); }
    }

    .change {
      font-size: 28px;
      color: #cccccc;
      will-change: transform, opacity;
      text-rendering: optimizeSpeed;
    }

    .positive {
      color: var(--change-positive);
    }

    .negative {
      color: var(--change-negative);
    }

    .error {
      font-size: 16px;
      color: #ff6666;
      margin-top: 10px;
      opacity: 0.8;
    }

    .menu-icons-container {
      position: absolute;
      top: 20px;
      right: 20px;
      display: flex;
      align-items: center;
      gap: 10px;
      z-index: 1000;
    }

    .menu-button {
      width: 40px;
      height: 40px;
      background-color: var(--battery-icon-color);
      border-radius: 50%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      cursor: pointer;
    }

    .menu-button span {
      width: 16px;
      height: 1.5px;
      background-color: var(--menu-button-color);
      margin: 2px 0;
      transition: all 0.2s ease;
    }

    .battery-icon {
      width: 40px;
      height: 40px;
      background-color: var(--battery-icon-color);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: var(--text-color);
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .night-mode .battery-icon.low {
      background-color: var(--change-negative);
    }

    .menu {
      position: absolute;
      top: 70px;
      right: 20px;
      background-color: #2a2a2a;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      display: none;
      flex-direction: column;
      z-index: 999;
      padding: 8px 0;
      min-width: 180px;
    }

    .menu.active {
      display: flex;
    }

    .menu-item {
      display: flex;
      align-items: center;
      padding: 10px 20px;
      color: var(--text-color);
      font-size: 16px;
      cursor: pointer;
      gap: 15px;
      transition: background-color 0.2s ease;
    }

    .menu-item:hover {
      background-color: rgba(74, 144, 226, 0.2);
    }

    .settings-form {
      display: none;
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #252525;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      z-index: 1001;
      color: var(--text-color);
      text-align: left;
      width: 300px;
      max-width: 90%;
    }

    .settings-form.active {
      display: block;
    }

    .settings-form h3 {
      margin: 0 0 20px;
      font-size: 20px;
      font-weight: 500;
      color: var(--text-color);
      text-align: center;
    }

    .settings-form input[type="checkbox"] {
      margin-right: 10px;
      accent-color: var(--primary-color);
    }

    .settings-form input[type="number"] {
      width: 80px;
      padding: 5px;
      background: #333;
      color: white;
      border: 1px solid #444;
      border-radius: 4px;
      margin-left: 10px;
    }

    .settings-form select {
      width: 100%;
      padding: 8px;
      background: #333;
      color: white;
      border: 1px solid #444;
      border-radius: 4px;
      margin-bottom: 15px;
    }

    .settings-form .button-group {
      display: flex;
      justify-content: space-between;
      gap: 12px;
      margin-top: 20px;
    }

    .settings-form button {
      flex: 1;
      padding: 12px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .settings-form .save-btn {
      background-color: var(--primary-color);
      color: #ffffff;
    }

    .settings-form .save-btn:hover {
      background-color: #357abd;
      transform: translateY(-1px);
    }

    .settings-form .cancel-btn {
      background-color: #404040;
      color: #e0e0e0;
    }

    .settings-form .cancel-btn:hover {
      background-color: #505050;
      transform: translateY(-1px);
    }

    .low-power-mode * {
      animation: none !important;
      transition: none !important;
    }

    @media (orientation: landscape) {
      .price {
        font-size: 120px;
      }
      .change {
        font-size: 32px;
      }
      h1 {
        font-size: 36px;
      }
    }

    @media (max-width: 600px) {
      .price {
        font-size: 70px;
      }
      .change {
        font-size: 22px;
      }
      h1 {
        font-size: 24px;
      }
      .menu-button, .battery-icon {
        width: 35px;
        height: 35px;
      }
      .menu-button span {
        width: 14px;
        height: 1.3px;
      }
      .battery-icon {
        font-size: 14px;
      }
      .menu {
        top: 60px;
        right: 15px;
        min-width: 160px;
      }
      .menu-item {
        font-size: 14px;
        padding: 8px 15px;
      }
      .settings-form {
        width: 280px;
        padding: 20px;
      }
      .settings-form button {
        padding: 10px;
        font-size: 13px;
      }
      .date-header {
        font-size: 14px;
        padding: 8px 14px;
      }
    }

    .offline-mode {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: #000;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 2000;
    }

    .offline-message {
      color: #fff;
      font-size: 32px;
      font-weight: bold;
      margin-bottom: 20px;
    }

    .battery-status {
      color: #fff;
      font-size: 24px;
      margin-top: 10px;
    }

    .alert-active {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 1500;
      color: white;
      font-size: 24px;
    }
  </style>
</head>
<body>
  <div class="date-header" id="dateHeader"></div>

  <div class="container">
    <h1 id="cryptoTitle">Bitcoin Price</h1>
    <div class="price" id="price">Loading...</div>
    <div class="change" id="change">24h Change: Loading...</div>
    <div class="error" id="error"></div>
  </div>

  <div class="menu-icons-container">
    <div class="battery-icon" id="batteryIcon">N/A</div>
    <div class="menu-button" id="menuButton">
      <span></span>
      <span></span>
      <span></span>
    </div>
  </div>

  <div class="menu" id="menu">
    <div class="menu-item" id="settings">
      <span class="material-icons">settings</span>
      <span>Settings</span>
    </div>
    <div class="menu-item" id="refresh">
      <span class="material-icons">refresh</span>
      <span>Refresh</span>
    </div>
    <div class="menu-item" id="nightModeToggle">
      <span class="material-icons">dark_mode</span>
      <span>Night Mode</span>
    </div>
    <div class="menu-item" id="about">
      <span class="material-icons">info</span>
      <span>About</span>
    </div>
    <div class="menu-item" id="exit">
      <span class="material-icons">logout</span>
      <span>Exit</span>
    </div>
  </div>

  <div class="settings-form" id="settingsForm">
    <h3>Settings</h3>
    
    <!-- هشدار قیمت در ردیف اول -->
    <label style="margin-bottom: 15px; display: flex; align-items: center;">
      <span style="margin-right: 10px;">Price Alert ($):</span>
      <input type="number" id="alertThresholdInput" style="flex: 1;">
    </label>
    
    <label style="margin-bottom: 15px;">
      <span style="margin-right: 10px;">Cryptocurrency:</span>
      <select id="currencySelect">
        <option value="bitcoin" selected>Bitcoin</option>
        <option value="ethereum">Ethereum</option>
      </select>
    </label>
    
    <label style="margin-bottom: 15px;">
      <span style="margin-right: 10px;">Update Interval:</span>
      <select id="updateIntervalSelect">
        <option value="60000">1 Minute</option>
        <option value="180000" selected>3 Minutes</option>
        <option value="300000">5 Minutes</option>
      </select>
    </label>
    
    <!-- تغییر متن Auto Night Mode به فرمت 24 ساعته -->
    <label>
      <input type="checkbox" id="autoNightMode"> Auto Night Mode (22:00-7:00)
    </label>
    
    <div class="button-group">
      <button class="save-btn" id="saveSettings">Save</button>
      <button class="cancel-btn" id="cancelSettings">Cancel</button>
    </div>
  </div>

  <div class="offline-mode" id="offlineMode" style="display: none;">
    <div class="offline-message">no internet connected</div>
    <div class="battery-status">battery level: <span id="offlineBatteryLevel">N/A</span></div>
  </div>

  <div class="alert-active" id="alertActive" style="display: none;">
    <div>Price Alert Active</div>
    <div style="font-size: 16px; margin-top: 10px;">Tap to stop alert</div>
  </div>

  <script>
    // Service Worker Registration for PWA
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/sw.js').then(registration => {
          console.log('ServiceWorker registration successful');
        }).catch(err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Keep screen always on
      if ('wakeLock' in navigator) {
        let wakeLock = null;
        const requestWakeLock = async () => {
          try {
            wakeLock = await navigator.wakeLock.request('screen');
            console.log('Screen will stay on');
          } catch (err) {
            console.error('Failed to acquire wake lock:', err);
          }
        };
        requestWakeLock();
        document.addEventListener('visibilitychange', () => {
          if (document.visibilityState === 'visible' && wakeLock === null) {
            requestWakeLock();
          }
        });
      }

      const priceElement = document.getElementById('price');
      const changeElement = document.getElementById('change');
      const errorElement = document.getElementById('error');
      const cryptoTitle = document.getElementById('cryptoTitle');
      const menuButton = document.getElementById('menuButton');
      const menu = document.getElementById('menu');
      const settings = document.getElementById('settings');
      const refresh = document.getElementById('refresh');
      const nightModeToggle = document.getElementById('nightModeToggle');
      const about = document.getElementById('about');
      const exit = document.getElementById('exit');
      const batteryIcon = document.getElementById('batteryIcon');
      const settingsForm = document.getElementById('settingsForm');
      const saveSettings = document.getElementById('saveSettings');
      const cancelSettings = document.getElementById('cancelSettings');
      const offlineMode = document.getElementById('offlineMode');
      const offlineBatteryLevel = document.getElementById('offlineBatteryLevel');
      const alertThresholdInput = document.getElementById('alertThresholdInput');
      const alertActive = document.getElementById('alertActive');
      const autoNightModeCheckbox = document.getElementById('autoNightMode');
      const currencySelect = document.getElementById('currencySelect');
      const updateIntervalSelect = document.getElementById('updateIntervalSelect');
      const dateHeader = document.getElementById('dateHeader');

      let lastBitcoinPrice = null;
      let audioContext = null;
      let beepInterval = null;
      let onlineStatus = navigator.onLine;
      let priceUpdateInterval = null;
      let currentBatteryLevel = 'N/A';
      let priceAlertThreshold = localStorage.getItem('priceAlertThreshold') ? parseFloat(localStorage.getItem('priceAlertThreshold')) : null;
      let isAppInBackground = false;
      let currentOscillator = null;
      let currentGainNode = null;
      let batteryWarningPlayed = false;
      let nightModeInterval = null;
      let isNightModeForced = false;
      let normalUpdateInterval = localStorage.getItem('updateInterval') ? parseInt(localStorage.getItem('updateInterval')) : 60000;
      let updateInterval = normalUpdateInterval;
      let isNightModeActive = false;

      // Update date header
      const updateDate = () => {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        dateHeader.textContent = `${year}-${month}-${day}`;
      };

      // Set initial alert threshold value
      if (priceAlertThreshold) {
        alertThresholdInput.value = priceAlertThreshold;
      }

      // Set initial currency value
      const savedCurrency = localStorage.getItem('selectedCurrency') || 'bitcoin';
      currencySelect.value = savedCurrency;

      // Set initial update interval value
      updateIntervalSelect.value = localStorage.getItem('updateInterval') || '180000';

      // Night mode functions
      const toggleNightMode = (enable) => {
        if (enable) {
          document.body.classList.add('night-mode', 'grayscale-mode');
          isNightModeForced = true;
          isNightModeActive = true;
          
          // Change update interval to 3 minutes in night mode
          updateInterval = 180000;
          
          if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
            priceUpdateInterval = setInterval(fetchPrice, updateInterval);
          }
          
          // In settings show "3 Minutes" for night mode
          updateIntervalSelect.value = '180000';
        } else {
          document.body.classList.remove('night-mode', 'grayscale-mode');
          isNightModeForced = false;
          isNightModeActive = false;
          
          // Restore normal update interval
          updateInterval = normalUpdateInterval;
          
          if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
            priceUpdateInterval = setInterval(fetchPrice, updateInterval);
          }
          
          // In settings show the normal interval
          updateIntervalSelect.value = normalUpdateInterval.toString();
          
          // Check auto night mode if not in manual mode
          if (autoNightModeCheckbox.checked) {
            checkAutoNightMode();
          }
        }
        
        menu.classList.remove('active');
      };

      const checkAutoNightMode = () => {
        if (!autoNightModeCheckbox.checked || isNightModeForced) return;
        
        const now = new Date();
        const hours = now.getHours();
        const isNightTime = hours >= 22 || hours < 7; // 22:00-7:00
        
        if (isNightTime) {
          document.body.classList.add('night-mode', 'grayscale-mode');
          isNightModeActive = true;
          
          // Change update interval to 3 minutes in night mode
          updateInterval = 180000;
          
          if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
            priceUpdateInterval = setInterval(fetchPrice, updateInterval);
          }
          
          // In settings show "3 Minutes" for night mode
          updateIntervalSelect.value = '180000';
        } else {
          document.body.classList.remove('night-mode', 'grayscale-mode');
          isNightModeActive = false;
          
          // Restore normal update interval
          updateInterval = normalUpdateInterval;
          
          if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
            priceUpdateInterval = setInterval(fetchPrice, updateInterval);
          }
          
          // In settings show the normal interval
          updateIntervalSelect.value = normalUpdateInterval.toString();
        }
      };

      const setupNightModeTimer = () => {
        if (nightModeInterval) clearInterval(nightModeInterval);
        
        checkAutoNightMode();
        nightModeInterval = setInterval(checkAutoNightMode, 60000); // Check every minute
      };

      // Manual night mode toggle
      nightModeToggle.addEventListener('click', () => {
        const isNightMode = document.body.classList.contains('night-mode');
        toggleNightMode(!isNightMode);
      });

      // About button click handler
      about.addEventListener('click', () => {
        menu.classList.remove('active');
        alert('Crypto Price App\nVersion 1.0\nA simple app to track cryptocurrency prices');
      });

      // Set auto night mode from localStorage
      autoNightModeCheckbox.checked = localStorage.getItem('autoNightMode') === 'true';

      // Battery status monitoring
      if (navigator.getBattery) {
        navigator.getBattery().then((battery) => {
          const updateBattery = () => {
            const batteryLevel = Math.round(battery.level * 100);
            currentBatteryLevel = batteryLevel;
            batteryIcon.textContent = batteryLevel;
            offlineBatteryLevel.textContent = batteryLevel;
            
            if (batteryLevel <= 15) {
              window.close();
            } else if (batteryLevel < 30) {
              // Only show red background in night mode
              if (document.body.classList.contains('night-mode')) {
                batteryIcon.classList.add('low');
              }
              document.documentElement.classList.add('low-power-mode');
              
              // Reduce update frequency
              if (priceUpdateInterval) {
                clearInterval(priceUpdateInterval);
                priceUpdateInterval = setInterval(fetchPrice, 180000); // 3 minutes
              }
              
              // Play warning sound once
              if (!batteryWarningPlayed) {
                playBatteryWarning();
                batteryWarningPlayed = true;
              }
            } else {
              batteryIcon.classList.remove('low');
              document.documentElement.classList.remove('low-power-mode');
              batteryWarningPlayed = false;
            }
          };
          updateBattery();
          battery.addEventListener('levelchange', updateBattery);
        });
      } else {
        batteryIcon.textContent = 'N/A';
        offlineBatteryLevel.textContent = 'N/A';
      }

      // Check online status
      const checkOnlineStatus = () => {
        onlineStatus = navigator.onLine;
        if (onlineStatus) {
          offlineMode.style.display = 'none';
          fetchPrice();
          if (!priceUpdateInterval && !isAppInBackground) {
            priceUpdateInterval = setInterval(fetchPrice, updateInterval);
          }
        } else {
          offlineMode.style.display = 'flex';
          offlineBatteryLevel.textContent = currentBatteryLevel;
          if (priceUpdateInterval) {
            clearInterval(priceUpdateInterval);
            priceUpdateInterval = null;
          }
        }
      };

      // Detect app background/foreground state
      document.addEventListener('visibilitychange', () => {
        isAppInBackground = document.hidden;
        if (isAppInBackground && priceUpdateInterval) {
          clearInterval(priceUpdateInterval);
          priceUpdateInterval = null;
        } else if (!isAppInBackground && onlineStatus && !priceUpdateInterval) {
          fetchPrice();
          priceUpdateInterval = setInterval(fetchPrice, updateInterval);
        }
      });

      // Play gentle beep sound for 15 seconds
      const playGentleAlert = () => {
        if (!onlineStatus) return;
        
        initAudio();
        
        if (beepInterval) clearInterval(beepInterval);
        if (currentOscillator) {
          currentOscillator.stop();
          currentOscillator = null;
        }
        if (currentGainNode) {
          currentGainNode.disconnect();
          currentGainNode = null;
        }
        
        currentOscillator = audioContext.createOscillator();
        currentGainNode = audioContext.createGain();
        currentOscillator.type = 'sine';
        currentOscillator.frequency.value = 800;
        currentGainNode.gain.value = 0.3;
        currentOscillator.connect(currentGainNode);
        currentGainNode.connect(audioContext.destination);
        currentOscillator.start();
        
        alertActive.style.display = 'flex';
        
        let beepCount = 0;
        const totalBeeps = 7; // 7 beeps in 15 seconds (every 2 seconds)
        
        beepInterval = setInterval(() => {
          beepCount++;
          
          // Alternate between two beep tones
          currentOscillator.frequency.value = beepCount % 2 === 0 ? 800 : 1000;
          
          if (beepCount >= totalBeeps) {
            stopAlert();
          }
        }, 2000); // Beep every 2 seconds
      };

      // Play battery warning sound (1 second)
      const playBatteryWarning = () => {
        initAudio();
        
        const oscillator = audioContext.createOscillator();
        const gainNode = audioContext.createGain();
        oscillator.type = 'sine';
        oscillator.frequency.value = 600;
        gainNode.gain.value = 0.5;
        oscillator.connect(gainNode);
        gainNode.connect(audioContext.destination);
        oscillator.start();
        
        setTimeout(() => {
          oscillator.stop();
        }, 1000);
      };

      // Stop the alert sound
      const stopAlert = () => {
        clearInterval(beepInterval);
        beepInterval = null;
        if (currentOscillator) {
          currentOscillator.stop();
          currentOscillator = null;
        }
        if (currentGainNode) {
          currentGainNode.disconnect();
          currentGainNode = null;
        }
        alertActive.style.display = 'none';
        // Clear alert history after completion
        priceAlertThreshold = null;
        localStorage.removeItem('priceAlertThreshold');
        alertThresholdInput.value = '';
      };

      // Check price alert conditions
      const checkPriceAlert = (currentPrice) => {
        if (!priceAlertThreshold || !lastBitcoinPrice) return;
        
        const difference = Math.abs(currentPrice - priceAlertThreshold);
        const isAboveThreshold = currentPrice > priceAlertThreshold;
        const wasBelowThreshold = lastBitcoinPrice <= priceAlertThreshold;
        const wasAboveThreshold = lastBitcoinPrice >= priceAlertThreshold;
        
        if ((isAboveThreshold && wasBelowThreshold) || 
            (!isAboveThreshold && wasAboveThreshold) || 
            difference <= 100) {
          playGentleAlert();
        }
      };

      // Initialize audio context
      const initAudio = () => {
        if (!audioContext) {
          audioContext = new (window.AudioContext || window.webkitAudioContext)();
        }
      };

      window.addEventListener('online', checkOnlineStatus);
      window.addEventListener('offline', checkOnlineStatus);

      menuButton.addEventListener('click', () => {
        menu.classList.toggle('active');
        settingsForm.classList.remove('active');
      });

      document.addEventListener('click', (e) => {
        if (!menu.contains(e.target) && !menuButton.contains(e.target) && !settingsForm.contains(e.target)) {
          menu.classList.remove('active');
          settingsForm.classList.remove('active');
        }
      });

      settings.addEventListener('click', () => {
        menu.classList.remove('active');
        settingsForm.classList.add('active');
      });

      refresh.addEventListener('click', () => {
        menu.classList.remove('active');
        if (onlineStatus) {
          fetchPrice();
        }
      });

      exit.addEventListener('click', () => {
        window.close();
      });

      // Add click event for date header to manually update prices
      dateHeader.addEventListener('click', () => {
        if (onlineStatus) {
          fetchPrice();
        }
      });

      saveSettings.addEventListener('click', () => {
        const selectedCurrency = currencySelect.value;
        localStorage.setItem('selectedCurrency', selectedCurrency);
        
        if (alertThresholdInput.value) {
          priceAlertThreshold = parseFloat(alertThresholdInput.value);
          localStorage.setItem('priceAlertThreshold', priceAlertThreshold);
        } else {
          priceAlertThreshold = null;
          localStorage.removeItem('priceAlertThreshold');
        }
        
        // Save night mode setting
        localStorage.setItem('autoNightMode', autoNightModeCheckbox.checked);
        
        // Save update interval (only if night mode is not active)
        if (!isNightModeActive) {
          normalUpdateInterval = parseInt(updateIntervalSelect.value);
          localStorage.setItem('updateInterval', normalUpdateInterval);
          updateInterval = normalUpdateInterval;
        }
        
        // Update the interval if it's changed
        if (priceUpdateInterval) {
          clearInterval(priceUpdateInterval);
          priceUpdateInterval = setInterval(fetchPrice, updateInterval);
        }
        
        settingsForm.classList.remove('active');
        if (onlineStatus) {
          fetchPrice();
        }
        
        // Setup night mode timer if auto mode is enabled
        if (autoNightModeCheckbox.checked) {
          setupNightModeTimer();
        }
      });

      cancelSettings.addEventListener('click', () => {
        settingsForm.classList.remove('active');
      });

      const fetchPrice = async () => {
        try {
          if (!onlineStatus || isAppInBackground) return;
          
          const selectedCurrency = localStorage.getItem('selectedCurrency') || 'bitcoin';
          const response = await fetch(`https://api.coingecko.com/api/v3/coins/${selectedCurrency}`);
          if (!response.ok) throw new Error('Failed to fetch data');
          const data = await response.json();
          const price = data.market_data.current_price.usd;
          const change = data.market_data.price_change_percentage_24h;

          cryptoTitle.textContent = `${selectedCurrency.charAt(0).toUpperCase() + selectedCurrency.slice(1)} Price`;
          priceElement.classList.add('price-update');
          changeElement.classList.add('price-update');
          setTimeout(() => {
            priceElement.classList.remove('price-update');
            changeElement.classList.remove('price-update');
          }, 500);

          // نمایش قیمت اتریوم به صورت رند شده
          if (selectedCurrency === 'ethereum') {
            priceElement.textContent = Math.round(price).toLocaleString();
          } else {
            priceElement.textContent = price.toLocaleString();
          }
          
          changeElement.textContent = `24h Change: ${change.toFixed(2)}%`;
          changeElement.className = 'change';
          changeElement.classList.add(change >= 0 ? 'positive' : 'negative');
          errorElement.textContent = '';

          if (selectedCurrency === 'bitcoin') {
            checkPriceAlert(price);
            lastBitcoinPrice = price;
          }
          
          localStorage.setItem(`${selectedCurrency}Price`, price);
          localStorage.setItem(`${selectedCurrency}Change`, change);

          // حل مشکل غیرفعال شدن حالت شب پس از آپدیت
          if (autoNightModeCheckbox.checked || isNightModeForced) {
            checkAutoNightMode();
          }
        } catch (error) {
          console.error('Error fetching data:', error);
          if (onlineStatus) {
            errorElement.textContent = 'Failed to load data. Showing last saved data.';
            const selectedCurrency = localStorage.getItem('selectedCurrency') || 'bitcoin';
            const savedPrice = localStorage.getItem(`${selectedCurrency}Price`);
            const savedChange = localStorage.getItem(`${selectedCurrency}Change`);
            if (savedPrice && savedChange) {
              cryptoTitle.textContent = `${selectedCurrency.charAt(0).toUpperCase() + selectedCurrency.slice(1)} Price`;
              
              if (selectedCurrency === 'ethereum') {
                priceElement.textContent = Math.round(savedPrice).toLocaleString();
              } else {
                priceElement.textContent = parseFloat(savedPrice).toLocaleString();
              }
              
              changeElement.textContent = `24h Change: ${parseFloat(savedChange).toFixed(2)}%`;
              changeElement.className = 'change';
              changeElement.classList.add(savedChange >= 0 ? 'positive' : 'negative');
            } else {
              priceElement.textContent = 'N/A';
              changeElement.textContent = 'N/A';
            }
          }
        }
      };

      // Stop alert when tapping anywhere during alert
      document.addEventListener('click', () => {
        if (beepInterval) {
          stopAlert();
        }
      });

      // Initial setup
      updateDate();
      checkOnlineStatus();
      setupNightModeTimer();
    });
  </script>
</body>
</html>
